name: Trabajo Practico | Agiles | CircleCI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  AZURE_WEBAPP_NAME: hangman-agiles    # set this to your application's name
  AZURE_WEBAPP_PACKAGE_PATH: '.'      # set this to the path to your web app project, defaults to the repository root
  DOTNET_VERSION: '3.1.101'           # set this to the dot net version to use

jobs:

  build:
  
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup of .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    - name: Dependencias
      run: dotnet restore
    - name: Compilacion
      run: dotnet build --configuration Release --no-restore
    - name: Code Quality
      id: code-inspector
      uses: codeinspectorio/github-action@master
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        code_inspector_access_key: ${{ secrets.ACCESS_KEY_INSPECTOR }}
        code_inspector_secret_key: ${{ secrets.SECRET_KEY_INSPECTOR }}
        min_quality_grade: 'WARNING'
        min_quality_score: '10'
        max_defects_rate: '0.1'
        max_complex_functions_rate: '0.1'
        max_long_functions_rate: '0.1'
        project_name: ''
        max_timeout_sec: '600'
    - name: Publish on Azure
      run: dotnet publish -c Release -o '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/hangman' 
    - name: Variable substitution
      uses: microsoft/variable-substitution@v1
      with:
        files: '${{env.AZURE_WEBAPP_PACKAGE_PATH}}/hangman/appsettings.json'
      env:
        ConnectionStrings.HangmanEntities: ${{ secrets.CONNECTIONSTRING }}
    - name: GoogleChrome
      run: |
        sudo apt install google-chrome-stable
    - name: Run Application
      run: |
        CHROME_VERSION=$(google-chrome --version | cut -f 3 -d ' ' | cut -d '.' -f 1) \
          && CHROMEDRIVER_RELEASE=$(curl --location --fail --retry 3 http://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}) \
          && curl --silent --show-error --location --fail --retry 3 --output /tmp/chromedriver_linux64.zip "http://chromedriver.storage.googleapis.com/$CHROMEDRIVER_RELEASE/chromedriver_linux64.zip" \
          && cd /tmp \
          && unzip chromedriver_linux64.zip \
          && rm -rf chromedriver_linux64.zip \
          && sudo mv chromedriver /usr/local/bin/chromedriver \
          && sudo chmod +x /usr/local/bin/chromedriver \
          && chromedriver --version          
    - uses: nanasess/setup-chromedriver@master
      with:
        chromedriver-version: '83.0.4103.39'
    - run: |
        export DISPLAY=:99
        chromedriver --url-base=/wd/hub &
        sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 & # optional
    - name: Chrome Run
      uses: azure/webapps-deploy@v2
      with: 
        app-name: ${{ env.AZURE_WEBAPP_NAME }} 
        publish-profile: ${{ secrets.PUBLISHPROFILE  }} 
        package: '${{ env.AZURE_WEBAPP_PACKAGE_PATH }}/hangman'
    - name: Testing
      run: |
        dotnet test
          # Deploy to Azure Web apps
